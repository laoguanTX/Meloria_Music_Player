# 音效均衡器修改总结

## 修改概述

根据用户要求，对音效均衡器进行了以下重要修改：

### 1. 可调范围修改
- **原范围**：-15dB ~ +15dB
- **新范围**：-15dB ~ +3dB
- **修改原因**：限制最大增益，避免过度增强导致音质失真

### 2. 调节精度提升
- **原精度**：0.5dB（60个分档）
- **新精度**：0.05dB（360个分档）
- **计算方式**：(3 - (-15)) / 0.05 = 18 / 0.05 = 360

### 3. 预设效果调整

#### 原预设范围：
- 低音增强: [6.0, 4.0, 2.0, ...]
- 人声增强: [0.0, 0.0, 0.0, 2.0, 4.0, 3.0, 2.0, ...]
- V型: [4.0, 2.0, 0.0, -2.0, -3.0, -3.0, -2.0, 0.0, 2.0, 4.0]

#### 新预设范围（适配-15dB~+3dB）：
- 低音增强: [3.0, 2.5, 1.5, ...]
- 人声增强: [0.0, 0.0, 0.0, 1.5, 2.5, 2.0, 1.5, ...]
- V型: [2.5, 1.5, 0.0, -1.5, -2.5, -2.5, -1.5, 0.0, 1.5, 2.5]

### 4. 界面调整

#### 4.1 笛卡尔坐标系修改
- **网格线间距**：从每5dB改为每3dB（-15, -12, -9, -6, -3, 0, +3）
- **Y轴范围计算**：从 `(gain + 15) / 30` 改为 `(gain + 15) / 18`
- **0dB基准线**：从 `size.height * 0.5` 改为 `size.height * (15.0 / 18.0)`

#### 4.2 滑块控制修改
- **最大值**：从15.0改为3.0
- **分档数**：从60改为360
- **增益显示**：从1位小数改为2位小数（`toStringAsFixed(2)`）

#### 4.3 界面标签更新
- **范围标签**：顶部从"+15dB"改为"+3dB"
- **网格标签**：自动适配新的3dB间距

### 5. 预设描述算法优化
- **阈值调整**：从±2dB改为±1dB
- **适配原因**：由于整体范围缩小，降低特征判断阈值

### 6. 文档更新
- **使用指南**：精度说明从0.5dB更新为0.05dB
- **调节建议**：范围建议从"±10dB以内"更新为"-10dB~+3dB以内"

## 技术实现细节

### 代码修改文件
1. `lib/screens/equalizer_screen.dart`
   - FrequencyResponsePainter类的绘制逻辑
   - 滑块范围和精度
   - 预设数值
   - 界面标签和显示格式

2. `Equalizer_Usage_Guide.md`
   - 精度描述更新
   - 使用建议更新

### 关键计算公式

#### Y轴坐标计算（新）
```dart
final y = size.height * (1 - (gain + 15) / 18);
```

#### 滑块分档计算
```dart
divisions: 360  // (3 - (-15)) / 0.05 = 360
```

#### 0dB基准线位置
```dart
size.height * (15.0 / 18.0)  // 0dB在新范围中的相对位置
```

## 优化效果

### 1. 音质保护
- 限制最大增益为+3dB，有效防止过度增强
- 保持-15dB的最大衰减，满足降噪需求

### 2. 精度提升
- 0.05dB精度提供专业级调节体验
- 360个分档确保平滑的调节过程

### 3. 用户体验
- 预设效果更加温和合理
- 界面显示更加精确（2位小数）
- 网格密度适中，便于读数

### 4. 专业性提升
- 符合专业音频设备的调节范围
- 避免业余用户过度调节的风险

## 兼容性说明

### BASS FFI接口
- 底层FFI接口保持不变
- 仅在Flutter界面层进行限制
- 确保与现有音频引擎兼容

### 设置持久化
- SharedPreferences存储格式不变
- 自动兼容旧版本设置数据
- 超出新范围的旧设置会被自动限制

## 测试建议

1. **范围测试**：确保滑块无法超出-15dB~+3dB范围
2. **精度测试**：验证0.05dB调节精度生效
3. **预设测试**：检查所有预设是否在新范围内
4. **界面测试**：确认图表和标签显示正确
5. **持久化测试**：验证设置保存和恢复功能

---

这些修改显著提升了均衡器的专业性和安全性，同时保持了良好的用户体验。
